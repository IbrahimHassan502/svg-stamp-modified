<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>

  <body class="bg-gray-100">
    <div class="relative">
      <div class="relative bg-opacity-75 bg-deep-purple-accent-700">
        <div
          class="relative px-4 py-16 mx-auto overflow-hidden sm:max-w-xl md:max-w-full lg:max-w-screen-xl md:px-24 lg:px-8 lg:py-20"
        >
          <div class="flex flex-col items-center justify-between xl:flex-row">
            <div class="w-full max-w-xl mb-12 xl:mb-0 xl:pr-16 xl:w-7/12">
              <div class="mb-12 flex justify-center" id="stampContainer">
                <!-- SVGs will be loaded here -->
              </div>
              <div class="mx-auto">
                <div
                  class="p-4 bg-white shadow-md rounded border border-gray-500"
                >
                  <form class="w-full max-w-xl mx-auto">
                    <div class="mb-4">
                      <label for="nameInput" class="block text-gray-700"
                        >Enter your name:</label
                      >
                      <div class="flex items-center">
                        <input
                          type="text"
                          id="nameInput"
                          class="w-full px-3 py-2 border border-gray-300 rounded"
                        />
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="loader"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        loadSVGs(["img/curved_stamp.svg", "img/block_stamp.svg"]);
      });

      function loadSVGs(svgPaths) {
        svgPaths.forEach((svgPath) => {
          fetch(svgPath)
            .then((response) => response.text())
            .then((svgData) => {
              const stampContainer = document.getElementById("stampContainer");
              const div = document.createElement("div");
              div.innerHTML = svgData;
              div.classList.add("inline-block");
              stampContainer.appendChild(div);
              return stampContainer;
            })
            .then((stampContainer) => {
              // ======= fontsize regulation variables
              //  variables for both functions
              const spacedTexts =
                stampContainer.querySelectorAll(".spaced-text");

              const originalFontSize = parseFloat(
                window
                  .getComputedStyle(spacedTexts[0])
                  .getPropertyValue("font-size")
              );

              // variables for the left stamp function
              const curvedTextContiner = stampContainer.querySelector(
                ".curved-text-container"
              );

              let curvedTextOffset = 0;

              const curvedSvg = stampContainer.querySelector(".curved-svg");

              const curvedText = stampContainer.querySelector(".curved-text");

              //   variables for the right stamp function
              const blockStampText =
                stampContainer.querySelector(".block-stamp-text");

              const blockTextContainer =
                stampContainer.querySelector("#textContainer");
              return {
                spacedTexts,
                originalFontSize,
                curvedTextContiner,
                curvedSvg,
                curvedText,
                curvedTextOffset,
                blockStampText,
                blockTextContainer,
              };
            })
            .then(
              ({
                spacedTexts,
                originalFontSize,
                curvedTextContiner,
                curvedSvg,
                curvedText,
                curvedTextOffset,
                blockStampText,
                blockTextContainer,
              }) => {
                const curvedTextScale = 0.04;
                const blockTextScale = 0.1;
                // =================== an initial solution to solve the "curvedSvg is not defined" error
                let curvedSvgBottom = "";
                if (curvedSvg) {
                  curvedSvgBottom = curvedSvg.getBoundingClientRect().bottom;
                }

                // ===================================== left function =====================================
                function regulateFontSizeLeft(overFlowCheck = false) {
                  const spacedTextFontSize = parseFloat(
                    window
                      .getComputedStyle(spacedTexts[0])
                      .getPropertyValue("font-size")
                  );

                  const curvedTextBottom =
                    curvedText.getBoundingClientRect().bottom;
                  /* 
                  the check for curvedSvgBottom is an initial solution to solve the "curvedSvg is not defined" error
                  */
                  if (
                    curvedSvgBottom &&
                    curvedTextBottom > curvedSvgBottom * 0.6
                  ) {
                    spacedTexts[0].style.fontSize = `${(
                      spacedTextFontSize *
                      (1 - curvedTextScale)
                    ).toFixed(1)}px`;

                    curvedTextContiner.style.transform = `translateY(${curvedTextOffset}px)`;
                    curvedTextOffset -= 0.45;

                    /*
                     **if the function is called from the else if which increase the fontsize when characters **are deleted it skips calling the function again to prevent infinite loop
                     */
                    if (!overFlowCheck) {
                      regulateFontSizeLeft();
                    }
                  } else if (spacedTextFontSize < originalFontSize) {
                    spacedTexts[0].style.fontSize = `${(
                      spacedTextFontSize *
                      (1 + curvedTextScale * 1.1)
                    ).toFixed(1)}px`;

                    curvedTextOffset += 0.5;
                    curvedTextContiner.style.transform = `translateY(${
                      curvedTextOffset < 0 ? curvedTextOffset : 0
                    }px)`;

                    regulateFontSizeLeft(true);
                  }
                }

                // ===================================== right function ====================================
                function regulateFontSizeRight(overFlowCheck = false) {
                  /*
                    every function in the .then() is apllied one time for each stamp which is two times in total so one time the block stamp text will be undifined and the other it will be fetched so the statement to avoid error whenever the block stamp text is undifined
                  */
                  if (blockStampText) {
                    // ===================================== fetching variable values ======================
                    const spacedTextFontSize = parseFloat(
                      window
                        .getComputedStyle(blockStampText)
                        .getPropertyValue("font-size")
                    );

                    const textContainerHeight =
                      blockTextContainer.getBoundingClientRect().height;

                    // ===================================== reducing fontsize =============================
                    if (
                      blockStampText.getBoundingClientRect().height >
                      textContainerHeight + 2
                    ) {
                      spacedTexts[1].style.fontSize = `${(
                        spacedTextFontSize *
                        (1 - blockTextScale)
                      ).toFixed(1)}px`;

                      /*
                       ** if the function is called from the else if which increases the font when characters are ** deleted it skips calling the function again to prevent infinite loop
                       */
                      if (!overFlowCheck) {
                        regulateFontSizeRight();
                      }
                    } else if (spacedTextFontSize < originalFontSize) {
                      /*
                      state to increase the fontsize in case of deleting characters to maintain proper fontsize
                      */
                      spacedTexts[1].style.fontSize = `${(
                        spacedTextFontSize *
                        (1 + blockTextScale / 2)
                      ).toFixed(1)}px`;

                      regulateFontSizeRight(true);
                    }
                  }
                }

                // ===================================== the stamp update function ==========================
                function updateName() {
                  const nameInput = document.getElementById("nameInput");
                  const newText = nameInput.value.toUpperCase();
                  document
                    .querySelectorAll('[id^="nameText"]')
                    .forEach((nameText) => {
                      nameText.textContent = newText;
                    });

                  // ===================================== function to reduce font size whenever paragraph wraps
                  regulateFontSizeLeft();
                  regulateFontSizeRight();
                }

                // ===================================== adding the update function to the input
                document
                  .getElementById("nameInput")
                  .addEventListener("input", updateName);
              }
            );
        });
      }
    </script>
  </body>
</html>
